;    LZO Compression / Decompression library
;    Military-grade stability and robustness.
;	* Requires no memory for decompression.
;	* Requires 64 kB of memory for compression.
;	* Algorithm is thread safe.
;	* supports overlapping compression and in-place decompression.
;    (c)1996-2008 Markus F.X.J. Oberhumer http://www.oberhumer.com/opensource/lzo
;    Delphi adpatation (c)2008 Arnaud Bouchez http://bouchez.info
;    Omegicus adaptation (c)2012 Vladislav Kabak http://omegicus.com
USE32


	  ;(var src; srclen: integer; var dst; var dstlen: integer;  var wrkmem)
ALIGN 4
ARCH_LZO_COMPRESS:
; in:  esi: data, ecx: data size[<=57344], edi: dest
; out: eax - result length
    @@: CMP	BYTE [LZO_SEMAFOR], 1
	JE     @B
	MOV	BYTE [LZO_SEMAFOR], 1
	MOV    DWORD [LZO_VAR_RES], 0
	;


	;(var src; srclen: integer; var dst; var dstlen: integer;var wrkmem)
       push edi

	PUSHd  LZO_BUF		   ; wrkmem
	PUSHd  LZO_VAR_RES	   ; dstlen
	PUSHd  EDI		     ; dst
	PUSHd  ECX	       ; srclen
	PUSHd  ESI		     ; src

	; ^src, dd srclen, ^dst, dd dstlen, ^wrkmem
	CALL   LZO_COMPRESS	      ; out = eax ???

      pop edi
	;stdcall LZO_COMPRESS, esi, 32000, edi, LZO_VAR_RES, dword[LZO_BUF]


	ADD    ESP, 4*5
	JMP   .OK
  .ERR: MOV    EAX, -1
	JMP   .EXIT
   .OK: MOV    EAX, DWORD[LZO_VAR_RES]
	JMP   .EXIT
     .EXIT:
	MOV    BYTE[LZO_SEMAFOR], 0
RET

LZO_COMPRESS:
;  src; srclen; dst; dstlen;  wrkmem
  mov	 eax, .dest
  add	 eax,  0x2F0
  jmp	 eax  ; startupcode different

align 4
.dest:
DD 0x83EC8B55,0x5653E8C4,0xC458B57,0x308558B,0xFC5589D0,0x89F3C283,0x458BF855,0xF4458918,0x8B10558B
DD 0xF08B0845,0x3304C083,0x8ADB33C9,0x588A0348,0x6E1C102,0xDB33CB33,0x8A05E1C1,0xCB330158,0xE1C1DB33
DD 0x33188A05,0xC1D98BCB,0xCB0305E1,0x8105E9C1,0x3FFFE1,0xEC4D8900,0x8BF44D8B,0xC8BEC5D,0x3BD98B99
DD 0x7E72085D,0xFB2BF88B,0x85F07D89,0x817376FF,0xBFFFF07D,0x6A770000,0xF07D81,0x76000008,0x3598A51
DD 0x7403583A,0xEC4D8B49,0x7FFE181,0xF1810000,0x201F,0x8BEC4D89,0x5D8BF44D,0x990C8BEC,0x5D3BD98B
DD 0x8B377208,0x89FB2BF8,0xFF85F07D,0x7D812C76,0xBFFFF0,0x81237700,0x800F07D,0xA760000,0x3A03598A
DD 0x2740358,0x8B6610EB,0x183B6619,0x598A0875,0x2583A02,0x4D8B1874,0xEC5D8BF4,0x40990489,0xFF8453B
DD 0x1D883,0xFF25E900,0x5D8BFFFF,0xEC7D8BF4,0x8BBB0489,0x85DE2BD8,0x89567EDB,0x7D83E85D,0x87703E8
DD 0x8E85D8A,0x3AEBFE5A,0x12E87D83,0x5D8A0B77,0x3EB80E8,0xEB421A88,0xE87D8B29,0x420002C6,0x8112EF83
DD 0xFFFF,0x81127600,0xFFEF,0x2C600,0xFFFF8142,0x77000000,0x88DF8BEE,0x1E8A421A,0x421A8846,0x75E84DFF
DD 0x3C083F5,0x4003598A,0x75FF583A,0x4598A2D,0xFF583A40,0x598A2475,0x583A4005,0x8A1B75FF,0x3A400659
DD 0x1275FF58,0x4007598A,0x75FF583A,0x8598A09,0xFF583A40,0x8B487674,0x81CE2BC8,0x800F07D,0xF18B0000
DD 0x4DFF2577,0x49CE8BF0,0x8A05E1C1,0xE380F05D,0x2E3C107,0xA88CB0A,0xF04D8B42,0x8803E9C1,0xF2E9420A
DD 0x81000000,0x4000F07D,0x13770000,0x8BF04DFF,0x2E980CE,0x8820C980,0xC1E9420A,0x81000000,0x4000F06D
DD 0x4D8B0000,0x81DE8BF0,0x4000E1,0x2EB8000,0x800BE9C1,0xCB0A10C9,0xE9420A88,0x9C,0x83FC7D8B,0x2EB09C1
DD 0xF83B4041,0x198A0676,0xF474183A,0xCE2BC88B,0x7D81F18B,0x4000F0,0xFF1E7700,0xFE83F04D,0x8B0D7721
DD 0x2E980CE,0x8820C980,0x64EB420A,0xC621EE83,0xEB422002,0xF06D813C,0x4000,0x7709FE83,0xF04D8B1B
DD 0xE181DE8B,0x4000,0xC102EB80,0xC9800BE9,0x88CB0A10,0x34EB420A,0x8B09EE83,0xE181F04D,0x4000
DD 0x800BE9C1,0xA8810C9,0xFFFE8142,0x76000000,0xFFEE8112,0xC6000000,0x81420002,0xFFFE,0x8BEE7700
DD 0x420A88CE,0x80F04D8A,0xE1C13FE1,0x420A8802,0xC1F04D8B,0xA8806E9,0x3BF08B42,0x573F845,0xFFFD52E9
DD 0x10552BFF,0x8914458B,0xFC458B10,0x5E5FC62B,0x5DE58B5B,0x909090C3,0x53EC8B55,0x758B5756,0xC7D8B10
DD 0xFF83DE8B,0x8B04770D,0x8B1BEBC7,0x8B521855,0x5351144D,0x8458B57,0xFCE6E850,0xC483FFFF,0x14558B14
DD 0xC0851A03,0x4D8B6676,0x2BCF0308,0x8BF33BC8,0x3D1175F9,0xEE,0xD08B0A77,0x8811C280,0x3FEB4313
DD 0x7703F883,0xFE430805,0xF88335EB,0x8B0A7712,0x3E980C8,0xEB430B88,0xC6D08B26,0x83430003,0xFA8112EA
DD 0xFF,0xEA811276,0xFF,0x430003C6,0xFFFA81,0xEE770000,0x8A431388,0xB88470F,0xF7754843,0x431103C6,0x430003C6
DD 0x430003C6,0x458BDE2B,0x33188914,0x5B5E5FC0,0x9090C35D

ret




ALIGN 4
ARCH_LZO_DECOMPRESS: ; in:  esi: data, ecx: data size[<=e000], edi: res.data
		     ; out: eax - result length
    @@: CMP    BYTE[LZO_SEMAFOR], 1
	JE     @b
	MOV    BYTE[LZO_SEMAFOR], 1
	MOV    DWORD[LZO_VAR_RES], 0


	PUSHd	LZO_VAR_RES
	PUSHd	EDI
	PUSHd	ECX
	PUSHd	ESI
	CALL   LZO_DECOMPRESS	     ; ^src, dd srclen, ^dst, dd dstlen


	ADD    ESP, 4*4
	;
     .EXIT:
	MOV    BYTE[LZO_SEMAFOR], 0
RET


;lzo_decompress(var src; srclen: integer; var dst; var dstlen: integer): integer; cdecl;
ALIGN 4
LZO_DECOMPRESS: ; return dd (?eax)
  push ebp
  mov ebp, esp

DB 0x51
DD 0x458B5653,0xC558B08,0xF08BD003,0x33FC5589,0x144D8BD2,0x68A1189,0x3C10558B,0x331C7611,0x83C88AC9
DD 0x8346EFC1,0x820F04F9,0x1C9,0x8846068A,0x75494202,0x3366EBF7,0x460E8AC9,0xF10F983,0x8D83,0x75C98500,0x8107EB18
DD 0xFFC1,0x3E804600,0x33F47400,0x83068AC0,0xC8030FC0,0x83068B46,0x28904C6,0x4904C283,0xF9832F74,0x8B217204,0x83028906
DD 0xC68304C2,0x4E98304,0x7304F983,0x76C985EE,0x46068A14,0x49420288,0x9EBF775,0x8846068A,0x75494202,0x8AC933F7
DD 0xF983460E,0xC12B7310,0x828D02E9,0xFFFFF7FF,0xC933C12B,0xC1460E8A,0xC12B02E1,0x8840088A,0x88A420A,0x420A8840
DD 0x288008A,0x113E942,0xF9830000,0x8B207240,0xFF428DD9,0x8302EBC1,0xC32B07E3,0x1E8ADB33,0x3E3C146,0x2B05E9C1
DD 0xD9E949C3,0x83000000,0x2F7220F9,0x851FE183,0xEB1875C9,0xFFC18107,0x46000000,0x74003E80,0x8AC033F4,0x1FC08306
DD 0xF46C803,0xFBC11EB7,0xFF428D02,0xC683C32B,0x8369EB02,0x457210F9,0xD98BC28B,0xC108E383,0xC32B0BE3,0x8507E183
DD 0xEB1875C9,0xFFC18107,0x46000000,0x74003E80,0x8ADB33F4,0x7C3831E,0xF46CB03,0xFBC11EB7,0x83C32B02,0xD03B02C6
DD 0x9A840F,0x2D0000,0xEB000040,0x2E9C11F,0x2BFF428D,0x8AC933C1,0xE1C1460E,0x8AC12B02,0xA884008,0x88008A42
DD 0x51EB4202,0x7206F983,0x2BDA8B37,0x4FB83D8,0x188B2E7C,0x8904C083,0x4C2831A,0x8B02E983,0x831A8918,0xC08304C2
DD 0x4E98304,0x7304F983,0x76C985EE,0x40188A20,0x49421A88,0x15EBF775,0x8840188A,0x188A421A,0x421A8840,0x8840188A
DD 0x7549421A,0x8AC933F7,0xE183FE4E,0xFC98503,0xFFFE4284,0x46068AFF,0x49420288,0xC933F775,0xE9460E8A,0xFFFFFECA
DD 0x8B10552B,0x10891445,0x75FC753B,0xEBC03304,0xFFF8B80D,0x753BFFFF,0x830372FC,0x5B5E04C0,0x90C35D59
ret
